---
import { type CollectionEntry, render } from "astro:content";
import EnhancedProse from "@/components/blog/EnhancedProse.astro";
import Masthead from "@/components/blog/Masthead.astro";
import ScrollProgressBar from "@/components/blog/ScrollProgressBar";
import TOCBar from "@/components/blog/TOCBar.astro";
import TOCMobile from "@/components/blog/TOCMobile.astro";
import { siteConfig } from "@/site.config";
import { calculateReadingTime } from "@/utils/readingTime";

import BaseLayout from "./Base.astro";

interface Props {
	post: CollectionEntry<"post">;
}

const { post } = Astro.props;
const { ogImage, title, description, updatedDate, publishDate } = post.data;
const socialImage = ogImage ?? `/og-image/${post.id}.png`;
const articleDate = updatedDate?.toISOString() ?? publishDate.toISOString();
const { headings } = await render(post);
const readingTime: string = calculateReadingTime(post);
const siteKey = new URL(siteConfig.url).hostname;

type AstroComponent = (props: Record<string, unknown>) => unknown;
// SOFT IMPORT (template-safe): comments are an optional feature in the public template repo.
// On my private site, `CommentsIsland.astro` exists and this renders normally.
const commentsModules = import.meta.glob("../components/blog/CommentsIsland.astro", { eager: true });
const CommentsIsland =
	(commentsModules["../components/blog/CommentsIsland.astro"] as unknown as { default?: AstroComponent })
		?.default;
---

<BaseLayout
	meta={{
		articleDate,
		description,
		ogImage: socialImage,
		title,
	}}
	disableHolidayOverlay
>
	<!-- Scroll Progress Bar -->
	<ScrollProgressBar client:load />

	<!-- Cover image hero background (full viewport width, behind header) -->
	{post.data.coverImage && (
		<div
			class="fixed inset-x-0 top-0 z-0 overflow-hidden"
			style={{ height: "60vh" }}
		>
			<img
				src={post.data.coverImage.src.src}
				alt=""
				class="w-full h-full object-cover blur-lg scale-105 opacity-40"
				loading="eager"
			/>
			<!-- Very light gradient overlay to maximize image visibility -->
			<div class="absolute inset-0 bg-gradient-to-b from-transparent via-transparent to-global-bg/10"></div>
			<div class="absolute inset-0 bg-gradient-to-b from-transparent via-global-bg/5 to-global-bg/40"></div>
			<div class="absolute bottom-0 left-0 right-0 h-20 bg-gradient-to-t from-global-bg to-transparent"></div>
		</div>
	)}

	<article class="relative z-10 grow break-words" data-pagefind-body data-blog-post="true">
		<div id="blog-hero" class="mb-12"><Masthead content={post} readingTime={readingTime} /></div>
		<div class="flex flex-col gap-10 lg:flex-row lg:items-start">
			<EnhancedProse class="blog-prose prose prose-base max-w-none prose-headings:font-semibold prose-headings:text-accent-2 prose-headings:relative prose-headings:scroll-mt-24 sm:prose-th:before:content-none">
				<slot />
			</EnhancedProse>
			{!!headings.length && (
				<TOCBar headings={headings}>
					{CommentsIsland && (
						<div data-pagefind-ignore>
							<CommentsIsland siteKey={siteKey} resourceType="post" resourceId={post.id} variant="sidebar" />
						</div>
					)}
				</TOCBar>
			)}
		</div>
	</article>

	<!-- Mobile: mount comments island for the comments button / overlay -->
	{CommentsIsland && (
		<div class="relative z-10 lg:hidden" data-pagefind-ignore>
			<CommentsIsland siteKey={siteKey} resourceType="post" resourceId={post.id} variant="overlay" />
		</div>
	)}

	<!-- Mobile TOC Component -->
	{!!headings.length && <TOCMobile headings={headings} />}

	<button
		class="fixed end-6 bottom-6 z-40 flex h-12 w-12 items-center justify-center rounded-xl bg-global-bg/55 ring-1 ring-white/5 text-global-text shadow-[0_6px_16px_-10px_rgba(0,0,0,0.35)] backdrop-blur-md transition-all duration-300 opacity-0 translate-y-16 cursor-pointer hover:text-accent hover:bg-global-bg/70 hover:scale-[1.07] focus:outline-none focus-visible:ring-2 focus-visible:ring-accent/50 focus-visible:ring-offset-2 focus-visible:ring-offset-global-bg active:scale-95 data-[show=true]:translate-y-0 data-[show=true]:opacity-100"
		style="-webkit-backdrop-filter: blur(12px); backdrop-filter: blur(12px);"
		data-show="false"
		id="to-top-btn"
		aria-label="Back to top"
		title="Back to top"
	>
		<svg
			xmlns="http://www.w3.org/2000/svg"
			fill="none"
			viewBox="0 0 24 24"
			stroke="currentColor"
			class="h-6 w-6 transition-colors duration-300 text-accent"
		>
			<path
				stroke-linecap="round"
				stroke-linejoin="round"
				stroke-width="2"
				d="M5 10l7-7m0 0l7 7m-7-7v18"
			></path>
		</svg>
	</button>
</BaseLayout>

<style is:global>
	/* Blog post prose: keep interactions subtle + theme-first */
	.blog-prose :is(h1, h2, h3, h4, h5, h6)[role='button'] {
		cursor: pointer;
	}

	.blog-prose :is(h1, h2, h3, h4, h5, h6)[role='button']:focus-visible {
		outline: 2px solid color-mix(in srgb, var(--color-accent) 55%, transparent);
		outline-offset: 4px;
		border-radius: 0.5rem;
	}

	/* Heading anchor links from rehype-autolink-headings */
	.blog-prose :is(h1, h2, h3, h4, h5, h6) > a.not-prose {
		color: inherit;
		text-decoration: none;
	}

	.blog-prose :is(h1, h2, h3, h4, h5, h6) > a.not-prose::after {
		content: '#';
		margin-left: 0.35rem;
		font-size: 0.85em;
		font-weight: 600;
		color: var(--color-accent);
		opacity: 0;
		transition: opacity 0.15s ease;
	}

	@media (hover: hover) {
		.blog-prose :is(h1, h2, h3, h4, h5, h6) > a.not-prose:hover::after {
			opacity: 0.65;
		}
	}

	.blog-prose :is(h1, h2, h3, h4, h5, h6) > a.not-prose:focus-visible::after {
		opacity: 0.65;
	}

	/* Lists: no slidey animations, just marker accent */
	.blog-prose :is(ul, ol) li::marker {
		color: color-mix(in srgb, var(--color-global-text) 70%, var(--color-accent) 30%);
	}

	@media (hover: hover) {
		.blog-prose :is(ul, ol) li:hover::marker {
			color: var(--color-accent);
		}
	}

	/* Blockquotes: soft surface + subtle border */
	.blog-prose blockquote {
		margin: 1.25rem 0;
		padding: 0.85rem 1.1rem;
		border-radius: 0.75rem;
		/* Match the site's “soft card” surfaces */
		background-color: color-mix(in srgb, var(--color-global-bg) 92%, var(--color-global-text) 8%);
		border: 1px solid color-mix(in srgb, var(--color-global-text) 14%, transparent);
		border-left: 4px solid color-mix(in srgb, var(--color-quote) 75%, transparent);
	}

	.blog-prose blockquote > :first-child {
		margin-top: 0;
	}

	.blog-prose blockquote > :last-child {
		margin-bottom: 0;
	}

	.blog-prose blockquote :is(p) {
		font-style: italic;
		/* Keep it readable and theme-consistent (mostly body text, slight quote tint) */
		color: color-mix(in srgb, var(--color-global-text) 88%, var(--color-quote) 12%);
	}

	/* Inline code: remove “clickable” feel; match site surfaces */
	.blog-prose :not(pre) > code {
		border: 1px solid color-mix(in srgb, var(--color-global-text) 20%, transparent);
		background-color: color-mix(in srgb, var(--color-global-text) 6%, transparent);
		border-radius: 0.375rem;
		padding: 0.1em 0.3em;
	}

	/* Tables: minimal row hover */
	@media (hover: hover) {
		.blog-prose table tbody tr:hover {
			background-color: color-mix(in srgb, var(--color-global-text) 3%, transparent);
		}
	}

	/* Expressive Code: fit the site's “card” language */
	.blog-prose .expressive-code figure.frame {
		border: 1px solid color-mix(in srgb, var(--color-global-text) 16%, transparent);
		border-radius: 0.75rem;
		overflow: hidden;
	}

	.blog-prose .expressive-code pre {
		margin: 0;
	}

	/* Expressive Code copy button: match site icon buttons */
	.blog-prose .expressive-code .copy button {
		border-radius: 0.75rem;
		color: var(--color-accent);
	}

	.blog-prose .expressive-code .copy button > div {
		background: color-mix(in srgb, var(--color-global-bg) 70%, transparent);
		backdrop-filter: blur(12px);
		-webkit-backdrop-filter: blur(12px);
		opacity: 0.22;
	}

	.blog-prose .expressive-code .copy button::before {
		border-color: color-mix(in srgb, var(--color-global-text) 18%, transparent);
		opacity: 1;
	}

	.blog-prose .expressive-code .copy button::after {
		background-color: currentColor;
	}

	@media (hover: hover) {
		.blog-prose .expressive-code .copy button:hover {
			color: var(--color-accent);
		}
	}

	@media (hover: hover) {
		.blog-prose .expressive-code .copy button:hover > div {
			opacity: 0.3;
		}
	}

	.blog-prose .expressive-code .copy button:active {
		transform: scale(0.96);
	}

	.blog-prose .expressive-code .copy button:active > div {
		opacity: 0.36;
	}

	.blog-prose .expressive-code .copy button:focus-visible {
		outline: 2px solid color-mix(in srgb, var(--color-accent) 55%, transparent);
		outline-offset: 3px;
	}

	/* Remove Expressive Code's built-in copied tooltip (it's a real element: .feedback) */
	.blog-prose .expressive-code .copy .feedback {
		display: none !important;
	}

</style>

<script>
	import { showToast } from "@/utils/toast";

	const scrollBtn = document.getElementById("to-top-btn") as HTMLButtonElement;
	const targetHeader = document.getElementById("blog-hero") as HTMLDivElement;
	const mobileActions = document.getElementById("mobile-toc-actions") as HTMLDivElement | null;
	const footerEl = document.querySelector("footer");

	// Dynamic safe area handling so buttons do not overlap footer
	const BASE_OFFSET = 24; // 1.5rem (bottom-6)
	const LIFTED_OFFSET = 96; // extra space when footer visible
	let footerVisible = false;

	function setButtonOffset(offsetPx: number) {
		scrollBtn.style.bottom = `${offsetPx}px`;
		if (mobileActions) mobileActions.style.bottom = `${offsetPx}px`;
	}

	function handleFooterIntersect(entries: IntersectionObserverEntry[]) {
		entries.forEach((entry) => {
			footerVisible = entry.isIntersecting;
			setButtonOffset(footerVisible ? LIFTED_OFFSET : BASE_OFFSET);
		});
	}

	if (footerEl) {
		const footerObserver = new IntersectionObserver(handleFooterIntersect, {
			root: null,
			threshold: 0,
			rootMargin: "0px 0px -40% 0px", // trigger a bit earlier
		});
		footerObserver.observe(footerEl);
	}

	function callback(entries: IntersectionObserverEntry[]) {
		entries.forEach((entry) => {
			// only show the scroll to top button when the heading is out of view
			scrollBtn.dataset.show = (!entry.isIntersecting).toString();
		});
	}

	scrollBtn.addEventListener("click", () => {
		document.documentElement.scrollTo({ behavior: "smooth", top: 0 });
	});

	const observer = new IntersectionObserver(callback);
	observer.observe(targetHeader);

	// Heading click to copy link functionality
	function setupHeadingLinks() {
		const headings = document.querySelectorAll<HTMLElement>(
			".blog-prose h1[id], .blog-prose h2[id], .blog-prose h3[id], .blog-prose h4[id], .blog-prose h5[id], .blog-prose h6[id]",
		);

			headings.forEach((heading) => {
			heading.addEventListener('click', async (e) => {
				e.preventDefault();
				const id = heading.getAttribute('id');
				if (id) {
					const url = `${window.location.origin}${window.location.pathname}#${id}`;

					try {
						await navigator.clipboard.writeText(url);
						showToast("Link copied to clipboard!", "success", 2000);

						// Update URL without scrolling
						history.pushState(null, '', `#${id}`);
					} catch (err) {
						console.error("Failed to copy link:", err);
					}
				}
			});

			// Add aria-label for accessibility
			const id = heading.getAttribute('id');
			if (id) {
				heading.setAttribute("aria-label", `Click to copy link to ${heading.textContent}`);
				heading.setAttribute("role", "button");
				heading.setAttribute("tabindex", "0");

				// Keyboard support
				heading.addEventListener("keydown", (e) => {
					const keyEvent = e as KeyboardEvent;
					if (keyEvent.key === "Enter" || keyEvent.key === " ") {
						e.preventDefault();
						heading.click();
					}
				});
			}
		});
	}

	function setupExpressiveCodeToasts() {
		const buttons = document.querySelectorAll<HTMLButtonElement>(
			".blog-prose .expressive-code .copy button",
		);

		buttons.forEach((btn) => {
			btn.addEventListener("click", () => {
				const copied = btn.getAttribute('data-copied');
				showToast(copied && copied.trim().length > 0 ? copied : "Copied!", "success", 2000);
			});
		});
	}

	// Run on page load
	setupHeadingLinks();
	setupExpressiveCodeToasts();

	// Re-run if content dynamically changes (for SPAs)
	if (document.addEventListener) {
		document.addEventListener("astro:page-load", () => {
			setupHeadingLinks();
			setupExpressiveCodeToasts();
		});
	}
</script>
