---
interface Props {
	statusCode?: number;
	attemptedPath: string;
}

const { statusCode = 404, attemptedPath } = Astro.props;
const attemptedCanonicalPath = toCanonicalRoute(attemptedPath);

function toCanonicalRoute(pathname: string): string {
	if (!pathname || pathname === "/") {
		return "/";
	}
	const withLeadingSlash = pathname.startsWith("/") ? pathname : `/${pathname}`;
	return withLeadingSlash.endsWith("/") ? withLeadingSlash : `${withLeadingSlash}/`;
}
---

<section class="mx-auto w-full max-w-3xl py-10 sm:py-14" data-attempted-path={attemptedCanonicalPath}>
	<div class="rounded-xl border border-accent/20 bg-global-bg p-6 shadow-sm sm:p-8">
		<p class="text-xs font-semibold uppercase tracking-wide text-accent">Client Error · {statusCode}</p>
		<h1 class="title mt-2 mb-4">This page could not be loaded.</h1>
		<p class="mb-3 text-base text-global-text/90">
			The requested URL
			<code class="mx-1 rounded-md border border-accent/20 bg-global-bg px-1.5 py-0.5 text-sm">
				{attemptedCanonicalPath}
			</code>
			is unavailable.
		</p>
		<p class="mb-6 text-sm text-global-text/75">
			Client errors are in the 4xx range and usually happen because a link changed, the path was typed incorrectly, or access is restricted.
		</p>

		<div class="flex flex-wrap gap-3">
			<button
				class="inline-flex items-center rounded-md border border-[var(--c-border)] bg-[var(--c-bg-dim)] px-3 py-2 text-sm font-medium hover:border-accent transition-colors"
				id="go-back-button"
				type="button"
			>
				Go Back
			</button>
			<a
				class="inline-flex items-center rounded-md border border-[var(--c-border)] bg-[var(--c-bg-dim)] px-3 py-2 text-sm font-medium hover:border-accent transition-colors"
				href="/"
			>
				Go Home
			</a>
		</div>

		<div class="mt-7 hidden border-t border-accent/15 pt-5" data-suggestion-root>
			<div class="mb-3 flex items-center justify-between gap-3">
				<p class="text-sm font-medium text-global-text">Did you mean:</p>
				<span class="hidden text-xs text-global-text/60" data-suggestion-tier></span>
			</div>
			<p class="hidden text-xs text-global-text/70" data-suggestion-loading>Checking close matches…</p>
			<div class="flex flex-wrap gap-3" data-suggestion-list></div>
		</div>
	</div>
</section>

<script>
	type RouteSuggestion = {
		route: string;
		similarity: number;
		tier: "primary" | "fallback";
	};

	const backButton = document.getElementById("go-back-button") as HTMLButtonElement | null;
	const suggestionRoot = document.querySelector("[data-suggestion-root]") as HTMLDivElement | null;
	const suggestionList = document.querySelector("[data-suggestion-list]") as HTMLDivElement | null;
	const suggestionTier = document.querySelector("[data-suggestion-tier]") as HTMLSpanElement | null;
	const suggestionLoading = document.querySelector("[data-suggestion-loading]") as HTMLParagraphElement | null;
	const attemptedPath =
		document
			.querySelector("[data-attempted-path]")
			?.getAttribute("data-attempted-path")
			?.trim() || "/";

	if (backButton) {
		backButton.addEventListener("click", () => {
			if (window.history.length > 1) {
				window.history.back();
				return;
			}
			window.location.assign("/");
		});
	}

	if (suggestionRoot && suggestionList && suggestionTier && suggestionLoading) {
		window.setTimeout(() => {
			void loadSuggestions();
		}, 0);
	}

	async function loadSuggestions(): Promise<void> {
		if (!suggestionRoot || !suggestionList || !suggestionTier || !suggestionLoading) {
			return;
		}

		suggestionRoot.classList.remove("hidden");
		const loadingTimer = window.setTimeout(() => {
			suggestionLoading.classList.remove("hidden");
		}, 250);

		const timeoutController = new AbortController();
		const abortTimer = window.setTimeout(() => timeoutController.abort(), 2500);

		try {
			const response = await fetch(`/api/route-suggestions?path=${encodeURIComponent(attemptedPath)}`, {
				cache: "no-store",
				signal: timeoutController.signal,
			});
			if (!response.ok) {
				hideSuggestions();
				return;
			}

			const payload = (await response.json()) as { suggestions?: RouteSuggestion[] };
			const suggestions = Array.isArray(payload.suggestions) ? payload.suggestions : [];

			if (suggestions.length === 0) {
				hideSuggestions();
				return;
			}

			renderSuggestions(suggestions);
		} catch {
			hideSuggestions();
		} finally {
			window.clearTimeout(loadingTimer);
			window.clearTimeout(abortTimer);
			suggestionLoading.classList.add("hidden");
		}
	}

	function hideSuggestions(): void {
		if (!suggestionRoot || !suggestionList || !suggestionTier) {
			return;
		}
		suggestionList.innerHTML = "";
		suggestionTier.textContent = "";
		suggestionTier.classList.add("hidden");
		suggestionRoot.classList.add("hidden");
	}

	function renderSuggestions(suggestions: RouteSuggestion[]): void {
		if (!suggestionList || !suggestionTier) {
			return;
		}

		suggestionList.innerHTML = "";
		const hasFallback = suggestions.some((item) => item.tier === "fallback");
		suggestionTier.textContent = hasFallback ? "Fallback match (70%+)" : "Strong match (80%+)";
		suggestionTier.classList.remove("hidden");

		for (const suggestion of suggestions) {
			const scorePercent = Math.round(suggestion.similarity * 100);
			const link = document.createElement("a");
			link.href = suggestion.route;
			link.className =
				"inline-flex min-w-[16rem] rounded-md border border-[var(--c-border)] bg-[var(--c-bg-dim)] px-3 py-2 text-sm font-medium hover:border-accent transition-colors";

			const topRow = document.createElement("span");
			topRow.className = "flex w-full items-center justify-between gap-3";

			const routeLabel = document.createElement("span");
			routeLabel.textContent = suggestion.route;
			routeLabel.className = "truncate";

			const scoreBadge = document.createElement("span");
			scoreBadge.textContent = `${scorePercent}%`;
			scoreBadge.className = "font-mono text-xs text-global-text/55";

			topRow.append(routeLabel, scoreBadge);
			link.append(topRow);
			suggestionList.append(link);
		}
	}
</script>
