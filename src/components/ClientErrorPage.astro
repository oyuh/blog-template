---
import { getAllPosts } from "@/data/post";
import { menuLinks } from "@/site.config";

interface Props {
	statusCode?: number;
	attemptedPath: string;
}

const { statusCode = 404, attemptedPath } = Astro.props;

const normalizedAttemptedPath = normalizeRoute(attemptedPath);
const staticRoutes = [
	"/",
	...menuLinks.map((link) => link.path),
	"/notes/",
	"/tags/",
	"/changelog/",
	"/info-stats/",
	"/themes/",
	"/resume/",
	"/policy/",
	"/policy/privacy/",
	"/policy/tos/",
];

const posts = await getAllPosts();
const postRoutes = posts.slice(0, 24).map((post) => toCanonicalRoute(`/posts/${post.id}/`));
const allCandidateRoutes = [...new Set([...staticRoutes.map(toCanonicalRoute), ...postRoutes])];

const suggestedRoutes = allCandidateRoutes
	.map((route) => ({
		route,
		score: routeScore(normalizedAttemptedPath, normalizeRoute(route)),
	}))
	.filter(({ route, score }) => route !== toCanonicalRoute(attemptedPath) && score <= scoreThreshold(normalizedAttemptedPath))
	.sort((left, right) => left.score - right.score)
	.slice(0, 2)
	.map(({ route }) => route);

function toCanonicalRoute(pathname: string): string {
	if (!pathname || pathname === "/") {
		return "/";
	}
	const withLeadingSlash = pathname.startsWith("/") ? pathname : `/${pathname}`;
	return withLeadingSlash.endsWith("/") ? withLeadingSlash : `${withLeadingSlash}/`;
}

function normalizeRoute(pathname: string): string {
	return toCanonicalRoute(pathname)
		.toLowerCase()
		.replace(/\/+$/g, "")
		.replace(/^\//, "");
}

function scoreThreshold(normalizedPathname: string): number {
	if (!normalizedPathname) {
		return 3;
	}
	return Math.max(4, Math.floor(normalizedPathname.length * 0.55));
}

function routeScore(normalizedSource: string, normalizedCandidate: string): number {
	const levenshteinDistance = computeLevenshteinDistance(normalizedSource, normalizedCandidate);
	const sourceSegments = normalizedSource.split("/").filter(Boolean);
	const candidateSegments = normalizedCandidate.split("/").filter(Boolean);
	const sharedSegments = sourceSegments.filter((segment) => candidateSegments.includes(segment)).length;
	const hasSharedPrefix =
		normalizedCandidate.startsWith(normalizedSource) || normalizedSource.startsWith(normalizedCandidate);

	let score = levenshteinDistance - sharedSegments;
	if (hasSharedPrefix) {
		score -= 2;
	}
	return score;
}

function computeLevenshteinDistance(sourceValue: string, targetValue: string): number {
	if (sourceValue === targetValue) {
		return 0;
	}
	if (!sourceValue.length) {
		return targetValue.length;
	}
	if (!targetValue.length) {
		return sourceValue.length;
	}

	const rows = sourceValue.length + 1;
	const columns = targetValue.length + 1;
	const matrix = Array.from({ length: rows }, () => Array<number>(columns).fill(0));

	for (let rowIndex = 0; rowIndex < rows; rowIndex += 1) {
		matrix[rowIndex]![0] = rowIndex;
	}
	for (let columnIndex = 0; columnIndex < columns; columnIndex += 1) {
		matrix[0]![columnIndex] = columnIndex;
	}

	for (let rowIndex = 1; rowIndex < rows; rowIndex += 1) {
		for (let columnIndex = 1; columnIndex < columns; columnIndex += 1) {
			const substitutionCost = sourceValue[rowIndex - 1] === targetValue[columnIndex - 1] ? 0 : 1;
			matrix[rowIndex]![columnIndex] = Math.min(
				matrix[rowIndex - 1]![columnIndex]! + 1,
				matrix[rowIndex]![columnIndex - 1]! + 1,
				matrix[rowIndex - 1]![columnIndex - 1]! + substitutionCost,
			);
		}
	}

	return matrix[rows - 1]![columns - 1]!;
}
---

<section class="mx-auto w-full max-w-3xl py-10 sm:py-14">
	<div class="rounded-xl border border-accent/20 bg-global-bg p-6 shadow-sm sm:p-8">
		<p class="text-xs font-semibold uppercase tracking-wide text-accent">Client Error Â· {statusCode}</p>
		<h1 class="title mt-2 mb-4">This page could not be loaded.</h1>
		<p class="mb-3 text-base text-global-text/90">
			The requested URL
			<code class="mx-1 rounded-md border border-accent/20 bg-global-bg px-1.5 py-0.5 text-sm">
				{toCanonicalRoute(attemptedPath)}
			</code>
			is unavailable.
		</p>
		<p class="mb-6 text-sm text-global-text/75">
			Client errors are in the 4xx range and usually happen because a link changed, the path was typed incorrectly, or access is restricted.
		</p>

		<div class="flex flex-wrap gap-3">
			<button
				class="inline-flex items-center rounded-md border border-[var(--c-border)] bg-[var(--c-bg-dim)] px-3 py-2 text-sm font-medium hover:border-accent transition-colors"
				id="go-back-button"
				type="button"
			>
				Go Back
			</button>
			<a
				class="inline-flex items-center rounded-md border border-[var(--c-border)] bg-[var(--c-bg-dim)] px-3 py-2 text-sm font-medium hover:border-accent transition-colors"
				href="/"
			>
				Go Home
			</a>
		</div>

		{
			suggestedRoutes.length > 0 && (
				<div class="mt-7 border-t border-accent/15 pt-5">
					<p class="mb-3 text-sm font-medium text-global-text">Did you mean:</p>
					<div class="flex flex-wrap gap-3">
						{suggestedRoutes.map((route) => (
							<a
								class="inline-flex items-center rounded-md border border-[var(--c-border)] bg-[var(--c-bg-dim)] px-3 py-2 text-sm font-medium hover:border-accent transition-colors"
								href={route}
							>
								Did you mean {route}
							</a>
						))}
					</div>
				</div>
			)
		}
	</div>
</section>

<script>
	const backButton = document.getElementById("go-back-button") as HTMLButtonElement | null;
	if (backButton) {
		backButton.addEventListener("click", () => {
			if (window.history.length > 1) {
				window.history.back();
				return;
			}
			window.location.assign("/");
		});
	}
</script>
