---
import { getAllPosts, getUniqueTagsWithCount } from "@/data/post";
import PageLayout from "@/layouts/Base.astro";

const allPosts = await getAllPosts();
const allTags = getUniqueTagsWithCount(allPosts);

const tagCards = allTags.map(([tag, count]) => {
	const postsWithTag = allPosts
		.filter((post) => post.data.tags.includes(tag))
		.sort((a, b) => b.data.publishDate.getTime() - a.data.publishDate.getTime());

	const coverImages: { src: string; alt: string }[] = [];
	for (const post of postsWithTag) {
		const cover = post.data.coverImage;
		if (cover?.src?.src) {
			coverImages.push({
				src: cover.src.src,
				alt: cover.alt ?? `Cover image for ${post.data.title}`,
			});
		}
		if (coverImages.length >= 3) {
			break;
		}
	}

	const featuredPosts = postsWithTag.slice(0, 3).map((post) => ({
		id: post.id,
		title: post.data.title,
	}));

	return { tag, count, coverImages, featuredPosts };
});

const meta = {
	description: "Explore every tag on the site and jump into recent posts that use it.",
	title: "All Tags",
};
---

<PageLayout meta={meta}>
	<div data-pagefind-ignore="all">
		<div class="mb-10 space-y-3">
			<h1 class="title text-3xl">Tags</h1>
			<p class="max-w-2xl text-base text-global-text/80 dark:text-global-text/70">
				Browse every topic I write about. Each tag highlights the latest posts and imagery that inspired them.
			</p>
		</div>
		<div class="grid gap-6 md:grid-cols-2 xl:grid-cols-3">
			{
				tagCards.map(({ tag, count, coverImages, featuredPosts }) => (
					<a
						class="group relative flex h-64 flex-col overflow-hidden rounded-2xl border border-zinc-400/60 bg-global-bg shadow-sm transition-all duration-300 hover:-translate-y-1 hover:border-accent hover:shadow-lg focus:outline-none focus-visible:ring-2 focus-visible:ring-accent"
						data-astro-prefetch
						href={`/tags/${tag}/`}
						title={`View ${count} post${count === 1 ? "" : "s"} tagged with ${tag}`}
					>
						<div class="absolute inset-0 overflow-hidden" aria-hidden="true">
							{coverImages.length > 0 && (
								<div
									class="absolute inset-0 grid h-full w-full transition-transform duration-500 group-hover:scale-[1.05]"
									style={`grid-template-columns: repeat(${coverImages.length}, minmax(0, 1fr));`}
								>
									{coverImages.map((image) => (
										<div
											class="relative h-full w-full bg-cover bg-center"
											style={`background-image: url(${image.src});`}
										/>
									))}
								</div>
							)}
							{coverImages.length === 0 && <div class="absolute inset-0 pointer-events-none tag-card-placeholder" />}
							<div class="absolute inset-0 pointer-events-none tag-card-overlay" />
							<div class="absolute inset-0 bg-grid-pattern opacity-30 mix-blend-overlay pointer-events-none" />
						</div>
						<div class="relative z-10 flex h-full flex-col justify-between p-6 text-white">
							<div class="space-y-2">
								<span class="text-xs uppercase tracking-[0.2em] text-white/85 drop-shadow-[0_2px_10px_rgba(8,12,20,0.6)]">Tag</span>
								<h2 class="text-2xl font-semibold text-white drop-shadow-[0_8px_20px_rgba(8,12,20,0.6)] transition-colors duration-300 group-hover:text-accent">
									&#35;{tag}
								</h2>
								<p class="text-sm text-white/90 drop-shadow-[0_5px_16px_rgba(8,12,20,0.6)]">
									{count} post{count === 1 ? "" : "s"}
								</p>
							</div>
							{featuredPosts.length > 0 && (
								<div class="mt-4 space-y-2 text-sm text-white/90 drop-shadow-[0_4px_14px_rgba(8,12,20,0.55)]">
									{featuredPosts.map((post) => (
										<div class="flex items-center gap-2 truncate">
											<span class="h-1.5 w-1.5 shrink-0 rounded-full bg-accent" aria-hidden="true" />
											<span class="truncate">{post.title}</span>
										</div>
									))}
								</div>
							)}
						</div>
					</a>
				))
			}
		</div>
	</div>
</PageLayout>

<style>
	.bg-grid-pattern {
		background-image: radial-gradient(circle, rgba(87, 130, 255, 0.12) 1px, transparent 1px);
		background-size: 22px 22px;
	}

	.tag-card-overlay {
		background: linear-gradient(140deg, rgba(10, 14, 25, 0.2) 0%, rgba(12, 16, 30, 0.52) 45%, rgba(10, 12, 20, 0.78) 100%);
		backdrop-filter: blur(3px);
		-webkit-backdrop-filter: blur(3px);
	}

	.tag-card-placeholder {
		background: linear-gradient(135deg, color-mix(in srgb, var(--color-accent) 70%, transparent) 0%, rgba(12, 16, 30, 0.82) 55%, rgba(8, 10, 18, 0.92) 100%);
		backdrop-filter: blur(7px);
		-webkit-backdrop-filter: blur(7px);
	}
</style>
